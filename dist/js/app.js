!function(e){function t(t){for(var n,r,l=t[0],c=t[1],i=t[2],u=0,d=[];u<l.length;u++)r=l[u],o[r]&&d.push(o[r][0]),o[r]=0;for(n in c)Object.prototype.hasOwnProperty.call(c,n)&&(e[n]=c[n]);for(f&&f(t);d.length;)d.shift()();return s.push.apply(s,i||[]),a()}function a(){for(var e,t=0;t<s.length;t++){for(var a=s[t],n=!0,l=1;l<a.length;l++){var c=a[l];0!==o[c]&&(n=!1)}n&&(s.splice(t--,1),e=r(r.s=a[0]))}return e}var n={},o={0:0},s=[];function r(t){if(n[t])return n[t].exports;var a=n[t]={i:t,l:!1,exports:{}};return e[t].call(a.exports,a,a.exports,r),a.l=!0,a.exports}r.m=e,r.c=n,r.d=function(e,t,a){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:a})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var a=Object.create(null);if(r.r(a),Object.defineProperty(a,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)r.d(a,n,function(t){return e[t]}.bind(null,n));return a},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="/dist/";var l=window.webpackJsonp=window.webpackJsonp||[],c=l.push.bind(l);l.push=t,l=l.slice();for(var i=0;i<l.length;i++)t(l[i]);var f=c;s.push([30,1]),a()}({26:function(e,t){},27:function(e,t){},28:function(e,t,a){},29:function(e,t,a){},30:function(e,t,a){"use strict";a.r(t);var n=a(1),o=a(0),s=a.n(o),r=a(2),l=a(6),c=a.n(l),i=a(7),f=a.n(i);function u(e){const t=["TITLE","SUBTITLE","BPM","WAVE","OFFSET","DEMOSTART","GENRE"],a=["COURSE","LEVEL","BALLOON","SCOREINIT","SCOREDIFF","TTROWBEAT"],n=["START","END","GOGOSTART","GOGOEND","MEASURE","SCROLL","BPMCHANGE","DELAY","BRANCHSTART","BRANCHEND","SECTION","N","E","M","LEVELHOLD","BMSCROLL","HBSCROLL","BARLINEOFF","BARLINEON","TTBREAK"];let o;if((o=e.match(/\/\/.*/))&&(e=e.substr(0,o.index).trim()),o=e.match(/^([A-Z]+):(.+)/i)){o[1];const e=o[1].toUpperCase(),n=o[2];if(t.includes(e))return{type:"header",scope:"global",name:e,value:n.trim()};if(a.includes(e))return{type:"header",scope:"course",name:e,value:n.trim()}}else if(o=e.match(/^#([A-Z]+)(?:\s+(.+))?/i)){o[1];const e=o[1].toUpperCase(),t=o[2]||"";if(n.includes(e))return{type:"command",name:e,value:t.trim()}}else if(o=e.match(/^([0-9]*,?)$/)){return{type:"data",data:o[1]}}return{type:"unknown",value:e}}function d(e,t){const a={course:"Easy",level:1,balloon:[],scoreInit:100,scoreDiff:100,ttRowBeat:16},n=[];let o=4,s=4,r={},l="",c=[];for(const e of t)if("header"===e.type)switch(e.name){case"COURSE":a.course=e.value;break;case"LEVEL":a.level=parseInt(e.value,10);break;case"BALLOON":const t=e.value.split(/[^0-9]/).filter(e=>""!==e).map(e=>parseInt(e,10));a.balloon=t;break;case"SCOREINIT":a.scoreInit=parseInt(e.value,10);break;case"SCOREDIFF":a.scoreDiff=parseInt(e.value,10);break;case"TTROWBEAT":a.ttRowBeat=parseInt(e.value,10)}else if("command"===e.type)switch(e.name){case"MEASURE":let t=e.value.match(/(\d+)\/(\d+)/);if(!t)break;o=parseInt(t[1],10),s=parseInt(t[2],10);break;case"GOGOSTART":c.push({name:"gogoStart",position:l.length});break;case"GOGOEND":c.push({name:"gogoEnd",position:l.length});break;case"SCROLL":c.push({name:"scroll",position:l.length,value:parseFloat(e.value)});break;case"BPMCHANGE":c.push({name:"bpm",position:l.length,value:parseFloat(e.value)});break;case"TTBREAK":r.ttBreak=!0}else if("data"===e.type){let t=e.data;if(t.endsWith(",")){const e={length:[o,s],properties:r,data:l+=t.slice(0,-1),events:c};n.push(e),l="",c=[],r={}}else l+=t}if(n.length){let t=!1;for(let e=0;e<n[0].events.length;e++){const a=n[0].events[e];if("bpm"===a.name&&0===a.position){t=!0;break}}t||n[0].events.unshift({name:"bpm",position:0,value:e.bpm})}let i=0;switch(a.course.toLowerCase()){case"easy":case"0":i=0;break;case"normal":case"1":i=1;break;case"hard":case"2":i=2;break;case"oni":case"3":i=3}return{course:i,headers:a,measures:n}}function p(e,t,a,n,o,s,r){e.beginPath(),e.moveTo(t,a),e.lineTo(n,o),e.lineWidth=s,e.strokeStyle=r,e.stroke(),e.closePath()}function h(e,t,a,n,o){e.beginPath(),e.arc(t,a,n,0,2*Math.PI,!1),e.fillStyle=o,e.fill(),e.closePath()}function g(e,t,a,n,o,s){e.fillStyle=s,e.fillRect(t,a,n,o)}function b(e,t,a,n,o,s){let r=arguments.length>6&&void 0!==arguments[6]?arguments[6]:"middle",l=arguments.length>7&&void 0!==arguments[7]?arguments[7]:"center";e.font=o,e.textBaseline=r,e.textAlign=l,e.fillStyle=s,e.fillText(n,t,a)}function m(e,t,a,n,o){b(e,t,a,n,'5px "Pixel 3x5"',o,arguments.length>5&&void 0!==arguments[5]?arguments[5]:"middle",arguments.length>6&&void 0!==arguments[6]?arguments[6]:"center")}const v=18,y=v+32,k=v+16,E=24,x=9,O=e=>64+(y+16)*e,B=e=>24+48*e;function S(e,t){return{x:B(t),y:O(e)+k}}function T(e,t,a,n){let o=!(arguments.length>4&&void 0!==arguments[4])||arguments[4];const s=S(t,a),r=s.x,l=s.y;h(e,r,l,x,"#000"),o?(h(e,r,l,x-1,"#fff"),h(e,r,l,x-2,n)):h(e,r,l,x-1,n)}function w(e,t,a,n){const o=S(t,a),s=o.x,r=o.y;h(e,s,r,x+3,"#000"),h(e,s,r,x+2,"#fff"),h(e,s,r,x,n)}function A(e,t,a,n,o,s,r){let l=arguments.length>7&&void 0!==arguments[7]?arguments[7]:"body",c=S(a,n),i=c.x,f=c.y,u=S(o,s),d=u.x,p=u.y;const h="gogo"===l,b="bodyBig"===l,m=h?k:x+(b?3:0);f-=m,p-=m;const y=h?v:2*x+(b?6:0);if(a===o){const t=d-i;h?g(e,i,f,t,y,r):(g(e,i,f,t,y,"#000"),g(e,i,f+1,t,y-2,"#fff"),g(e,i,f+2,t,y-4,r))}else{const n=t[a].totalBeat,l=B(n)-i+E;h?g(e,i,f,l,y,r):(g(e,i,f,l,y,"#000"),g(e,i,f+1,l,y-2,"#fff"),g(e,i,f+2,l,y-4,r));for(let n=a+1;n<o;n++){let a=O(n),o=B(t[n].totalBeat)+E;h?g(e,0,a,o,y,r):(g(e,0,a+=k-x-(b?3:0),o,y,"#000"),g(e,0,a+1,o,y-2,"#fff"),g(e,0,a+2,o,y-4,r))}const c=B(s);h?g(e,0,p,c,y,r):(g(e,0,p,c,y,"#000"),g(e,0,p+1,c,y-2,"#fff"),g(e,0,p+2,c,y-4,r))}}function R(e,t,a,n,o,s){T(e,a,n,"#fe4"),T(e,o,s,"#fe4"),A(e,t,a,n,o,s,"#fe4","body")}function C(e,t,a,n,o,s){w(e,a,n,"#fe4"),w(e,o,s,"#fe4"),A(e,t,a,n,o,s,"#fe4","bodyBig")}function L(e,t,a,n,o,s,r){T(e,o,s,"#fb4"),A(e,t,a,n,o,s,"#fb4","body"),T(e,a,n,"#fb4",!1);const l=S(a,n);m(e,l.x,l.y+.5,r.toString(),"#000")}var F=function(e,t){const a=e.courses[t],n=a.headers.ttRowBeat,o=[];let s=[],r=0;for(let e=0;e<a.measures.length;e++){const t=a.measures[e],l=t.length[0]/t.length[1]*4;(n<r+l||t.properties.ttBreak)&&(o.push({beats:r,measures:s}),s=[],r=0),s.push(t),r+=l}s.length&&o.push({beats:r,measures:s});const l=24+48*n+E,c=64+(y+16)*o.length+8,i=document.createElement("canvas");i.width=l,i.height=c;const f=i.getContext("2d");g(f,0,0,l,c,"#cccccc");for(let e=0;e<o.length;e++){const t=o[e],a=t.beats;t.measures;t.totalBeat=a;const n=24+48*a+E,s=O(e);g(f,0,s+v,n,32,"#000"),g(f,0,s+v+2,n,28,"#fff"),g(f,0,s+v+4,n,24,"#999")}b(f,8,8,e.headers.title,"bold 28px sans-serif","#000","top","left");b(f,8,40,["かんたん","ふつう","むずかしい","おに"][a.course]+" "+"★".repeat(a.headers.level)+"☆".repeat(Math.max([5,7,8,10][a.course]-a.headers.level,0)),"bold 20px sans-serif","#000","top","left");let u=!1,d=1;for(let e=0;e<o.length;e++){const t=o[e].measures;let a=0;for(let n=0;n<t.length;n++){const s=t[n],r=s.length[0]/s.length[1]*4;s.rowBeat=a;for(let t=0;t<s.events.length;t++){const n=s.events[t],l=a+r/(s.data.length||1)*n.position;"gogoStart"===n.name?u=[e,l]:"gogoEnd"===n.name&&(A(f,o,u[0],u[1],e,l,"#fbb","gogo"),u=!1)}a+=r}}for(let e=0;e<o.length;e++){const t=o[e].measures;let a=0;const n=O(e);for(let e=0;e<t.length;e++){const o=B(a),s=t[e],r=s.length[0]/s.length[1]*4,l=n+v;for(let e=1;e<2*s.length[0];e++){const t=e/s.length[1]*2,n=B(a+t);p(f,n,l,n,l+32,2,"#fff"+(e%2?"4":"8"))}for(let e=0;e<s.events.length;e++){const t=s.events[e],o=r/(s.data.length||1)*t.position,l=B(a+o);"scroll"===t.name?(p(f,l,n,l,n+y,2,"#444"),m(f,l+2,n+v-13,"HS "+t.value.toString(),"#f00","bottom","left")):"bpm"===t.name&&(p(f,l,n,l,n+y,2,"#444"),m(f,l+2,n+v-7,"BPM "+t.value.toString(),"#00f","bottom","left"))}if(p(f,o,n,o,n+y,2,"#fff"),m(f,o+2,n+v-1,d.toString(),"#000","bottom","left"),d+=1,a+=r,e+1===t.length){const e=B(a);p(f,e,n,e,n+y,2,"#fff")}}}let h=!1,k=0;for(let e=0;e<o.length;e++){const t=o[e].measures;for(let e=0;e<t.length;e++){const a=t[e];for(let e=a.data.length;e>=0;e--){const t=a.data.charAt(e);"7"!==t&&"9"!==t||(k+=1)}}}if(a.headers.balloon.length<k)throw new Error("BALLOON count mismatch");for(let e=o.length-1;e>=0;e--){const t=o[e].measures;for(let n=t.length-1;n>=0;n--){const s=t[n],r=s.length[0]/s.length[1]*4;for(let t=s.data.length;t>=0;t--){const n=s.data.charAt(t),l=s.rowBeat+r/s.data.length*t;switch(n){case"1":T(f,e,l,"#f33");break;case"2":T(f,e,l,"#5cf");break;case"3":w(f,e,l,"#f33");break;case"4":w(f,e,l,"#5cf");break;case"5":R(f,o,e,l,h[0],h[1]),h=!1;break;case"6":C(f,o,e,l,h[0],h[1]),h=!1;break;case"7":case"9":const t=a.headers.balloon[k-1];L(f,o,e,l,h[0],h[1],t),k-=1,h=!1;break;case"8":h=[e,l]}}}}return i};var I=function(e,t){const a=function(e){const t=[],a=[];let n=0,o=0;for(let s=0;s<e.measures.length;s++){const r=e.measures[s],l=r.length[0]/r.length[1]*4;for(let e=0;e<r.events.length;e++){const a=r.events[e],o=l/(r.data.length||1)*a.position;"bpm"===a.name&&t.push({type:"bpm",value:a.value,beat:n+o})}for(let t=0;t<r.data.length;t++){const s=r.data.charAt(t);let c={type:"",beat:n+l/r.data.length*t};switch(s){case"1":c.type="don";break;case"2":c.type="kat";break;case"3":c.type="donBig";break;case"4":c.type="katBig";break;case"5":c.type="renda";break;case"6":c.type="rendaBig";break;case"7":case"9":c.type="balloon",c.count=e.headers.balloon[o++];break;case"8":c.type="end"}c.type&&a.push(c)}n+=l}return function(e,t){let a=120,n=0,o=0,s=0,r=0,l=[];for(;r<t.length;){let c=e[s],i=t[r];for(;c&&c.beat<=i;){if("bpm"===c.type){let e=c.beat-n;n+=e,o+=60/a*e,a=c.value}c=e[++s]}let f=i-n,u=60/a*f;l.push(o+u),n+=f,o+=u,r++}return l}(t,a.map(e=>e.beat)).forEach((e,t)=>{a[t].time=e}),{events:t,notes:a}}(e.courses[t]);return{statistics:function(e){const t=[0,0,0,0],a=[],n=[];let o=0,s=0,r=0,l=!1,c=!1,i=0;const f=["don","kat","donBig","katBig"];for(let u=0;u<e.notes.length;u++){const d=e.notes[u],p=f.indexOf(d.type);-1===p?"renda"!==d.type&&"rendaBig"!==d.type?"balloon"!==d.type?"end"===d.type&&(l?(a.push(d.time-l),l=!1):c&&(n.push([d.time-c,i]),c=!1)):(c=d.time,i=d.count):l=d.time:(0===u&&(o=d.time),s=d.time,t[p]+=1,r+=1)}return{totalCombo:r,notes:t,length:s-o,rendas:a,balloons:n}}(a),graph:function(e){const t=[];let a={don:0,kat:0},n=0;const o=e.notes[e.notes.length-1].time/100,s=["don","kat","donBig","katBig"];for(let r=0;r<e.notes.length;r++){const l=e.notes[r];if(-1!==s.indexOf(l.type)){for(;(t.length+1)*o<=l.time;){const e=a.don+a.kat;n<e&&(n=e),t.push(a),a={don:0,kat:0}}"don"===l.type||"donBig"===l.type?a.don+=1:"kat"!==l.type&&"katBig"!==l.type||(a.kat+=1)}}for(;t.length<100;)t.push({don:0,kat:0});return{timeframe:o,max:n,data:t}}(a)}};a(28),a(29);const N=s()(".editor-live"),M=s()(".editor-process"),P=s()(".area-editor .input"),D=s()(".area-errors .errors");let j=null,G="",U="preview";function $(e){D.text(e)}function H(){s()(".controls-diff .button.is-active").removeClass("is-active"),s()(`.controls-diff .btn-diff-${G}`).addClass("is-active"),s()(".controls-page .button.is-active").removeClass("is-active"),s()(`.controls-page .btn-page-${U}`).addClass("is-active"),s()(".area-pages .page").addClass("is-hidden"),s()(`.area-pages .page-${U}`).removeClass("is-hidden"),"preview"===U&&""!==G?W():s()("#tja-preview").remove(),"statistics"===U&&function(){if(""===G)return;try{const e=I(j,G);!function(e){const t=e.statistics,a=e.graph;s()(".stat-total-combo").text(t.totalCombo),s()(".stat-don-small").text(t.notes[0]),s()(".stat-don-big").text(t.notes[2]),s()(".stat-kat-small").text(t.notes[1]),s()(".stat-kat-big").text(t.notes[3]);const n=t.notes[0]+t.notes[2],o=t.notes[1]+t.notes[3];s()(".stat-don").text(n),s()(".stat-kat").text(o);const l=n/t.totalCombo*100,c=100-l;s()(".stat-don-ratio").text(l.toFixed(2)+"%"),s()(".stat-kat-ratio").text(c.toFixed(2)+"%"),s()(".stat-density").text((t.totalCombo/t.length).toFixed(3)),s()(".stat-length").text(t.length.toFixed(2)),s()(".stat-renda").text(t.rendas.map(e=>e.toFixed(3)+"秒").join(" + ")),s()(".stat-renda-total").text(t.rendas.reduce((e,t)=>e+t,0).toFixed(3)),s()(".stat-balloon").html(t.balloons.map(e=>`${e[0].toFixed(3)}秒 / ${e[1]}打 (${(e[1]/e[0]).toFixed(3)}打/秒)`).join("<br>"));const i=r.b().rangeRound([0,600]),f=r.c().rangeRound([200,0]),u=5*Math.ceil(a.max/5),d=[...Array(u/5+1).keys()].map(e=>5*e);s()(".stat-graph").empty();const p=r.d(".stat-graph").attr("width",650).attr("height",240).append("g").attr("transform","translate(30, 20)"),h=r.e().keys(["don","kat"])(a.data);i.domain(h[0].map((e,t)=>t)),f.domain([0,5*Math.ceil(a.max/5)]);const g=()=>r.a(f).ticks(5).tickValues(d);p.append("g").attr("class","grid").call(g().tickSize(-600).tickFormat("")),p.selectAll(".layer").data(h).enter().append("g").attr("class","layer").style("fill",(e,t)=>["#f44e","#44fe"][t]).selectAll("rect").data(e=>e).enter().append("rect").attr("x",(e,t)=>i(t)).attr("y",e=>f(e[1])).attr("height",e=>f(e[0])-f(e[1])).attr("width",i.bandwidth),p.append("g").attr("class","axis-y").call(g())}(e)}catch(e){console.error(e),$(e.message)}}()}function V(){try{j=function(e){const t=e.split(/(\r\n|\r|\n)/).map(e=>e.trim()),a={title:"",subtitle:"",bpm:120,wave:"",offset:0,demoStart:0,genre:""},n={};let o,s=[];for(o=0;o<t.length;o++){const e=t[o];if(""===e)continue;const r=u(e);if("header"===r.type&&"global"===r.scope)switch(r.name){case"TITLE":a.title=r.value;break;case"SUBTITLE":a.subtitle=r.value;break;case"BPM":a.bpm=parseFloat(r.value);break;case"WAVE":a.wave=r.value;break;case"OFFSET":a.offset=parseFloat(r.value);break;case"DEMOSTART":a.demoStart=parseFloat(r.value);break;case"GENRE":a.genre=r.value}else if("header"===r.type&&"course"===r.scope){if("COURSE"===r.name&&s.length){const e=d(a,s);n[e.course]=e,s=[]}s.push(r)}else"command"===r.type?s.push(r):"data"===r.type&&s.push(r)}if(s.length){const e=d(a,s);n[e.course]=e}return{headers:a,courses:n}}(P.first().value),s()(".controls-diff .button").addClass("is-hidden");for(let e in j.courses)s()(`.controls-diff .btn-diff-${e}`).removeClass("is-hidden");$("No error")}catch(e){console.error(e),$(e.message)}}function W(){if(""!==G)try{s()("#tja-preview").remove();const e=F(j,G);e.id="tja-preview",s()(".page-preview").append(e),$("No error")}catch(e){console.error(e),$(e.message)}}M.on("click",()=>{V(),W()}),P.on("input",()=>{N.first().checked&&(V(),H())}),P.on("dragover",e=>{e.stopPropagation(),e.preventDefault(),e.dataTransfer.dropEffect="cppy"}),P.on("drop",e=>{e.stopPropagation(),e.preventDefault();const t=e.dataTransfer.files[0],a=new FileReader;a.onload=(e=>{const t=e.target.result,a=new Uint8Array(t),o=n.Buffer.from(a),s=c.a.detect(o),r=f.a.decode(o,s);P.first().value=r,G="",V(),H()}),a.readAsArrayBuffer(t)}),s()(".controls-diff .button").on("click",e=>{const t=s()(e.target).data("value");G=t,H()}),s()(".controls-page .button").on("click",e=>{const t=s()(e.target).data("value");U=t,H()}),P.first().value&&V(),H()}});